app-id: tv.plex.PlexDesktop
runtime: org.freedesktop.Platform
runtime-version: "25.08"
sdk: org.freedesktop.Sdk
command: Plex
finish-args:
  - --socket=x11
  - --socket=pulseaudio
  - --device=all
  - --share=ipc
  - --share=network
  - --talk-name=org.freedesktop.ScreenSaver

cleanup:
  - /include
  - /lib/cmake
  - /lib/pkgconfig
  - "*.a"
  - "*.la"
modules:
  - name: plex-metadata
    buildsystem: simple
    build-commands:
      - install -Dm644 tv.plex.PlexDesktop.desktop /app/share/applications/tv.plex.PlexDesktop.desktop
      - install -Dm664 tv.plex.PlexDesktop.png /app/share/icons/hicolor/256x256/apps/tv.plex.PlexDesktop.png
      - install -Dm664 tv.plex.PlexDesktop.metainfo.xml /app/share/metainfo/tv.plex.PlexDesktop.metainfo.xml
    sources:
      - type: file
        path: tv.plex.PlexDesktop.desktop
      - type: file
        path: tv.plex.PlexDesktop.png
      - type: file
        path: tv.plex.PlexDesktop.metainfo.xml

  - name: libjpeg # with libjpeg.so.8
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_SKIP_RPATH:BOOL=YES
      - -DENABLE_STATIC:BOOL=NO
      - -DWITH_JPEG8:BOOL=YES
      - -DWITH_TURBOJPEG:BOOL=NO
      - -DCMAKE_INSTALL_LIBDIR=/app/lib # uses lib64 by default
      - -DCMAKE_POLICY_VERSION_MINIMUM=3.5
    cleanup: [/share, /bin]
    sources:
      - type: archive
        url: https://github.com/libjpeg-turbo/libjpeg-turbo/archive/refs/tags/2.1.3.tar.gz
        sha256: dbda0c685942aa3ea908496592491e5ec8160d2cf1ec9d5fd5470e50768e7859

  - name: libevent
    buildsystem: cmake-ninja
    config-opts:
      - -DEVENT__LIBRARY_TYPE=SHARED
      - -DCMAKE_POLICY_VERSION_MINIMUM=3.5
    cleanup: [/bin]
    sources:
      - type: git
        url: https://github.com/libevent/libevent/
        tag: release-2.1.12-stable

  - name: libwebp
    buildsystem: autotools
    config-opts: [--disable-static, --enable-libwebpmux, --disable-libwebpdemux]
    cleanup: [/share, /bin]
    sources:
      - type: archive
        url: https://github.com/webmproject/libwebp/archive/refs/heads/0.5.1.zip
        sha256: fdef2c0404b5868888008996438525d44fdb049327f92576579a32df4b30ea27

  - name: libsnappy
    buildsystem: cmake-ninja
    config-opts:
      - "-DBUILD_SHARED_LIBS=ON"
      - "-DSNAPPY_BUILD_TESTS=OFF"
      - "-DCMAKE_BUILD_TYPE=RelWithDebInfo"
      - "-DCMAKE_POLICY_VERSION_MINIMUM=3.5"
      - "-DCMAKE_INSTALL_LIBDIR=/app/lib" # uses lib64 by default
    sources:
      - type: git
        url: https://github.com/google/snappy
        tag: 1.1.7

  - name: minizip
    subdir: contrib/minizip
    config-opts:
      - --disable-static
    sources:
      - type: archive
        url: https://zlib.net/fossils/zlib-1.3.1.tar.gz
        sha256: 9a93b2b7dfdac77ceba5a558a580e74667dd6fede4585b91eefb60f03b72df23
        x-checker-data:
          type: anitya
          project-id: 5303
          stable-only: true
          url-template: https://zlib.net/fossils/zlib-$version.tar.gz
      - type: shell
        commands:
          - GLOBIGNORE=contrib && rm -rf *
          - GLOBIGNORE=contrib/minizip && rm -rf contrib/*
          - rm -f contrib/minizip/Makefile
          - autoreconf -fiv contrib/minizip

  - name: libxml2
    buildsystem: cmake-ninja
    config-opts:
      - "-DBUILD_SHARED_LIBS=ON"
      - "-DLIBXML2_WITH_HTML=OFF"
      - "-DCMAKE_INSTALL_LIBDIR=/app/lib" # uses lib64 by default
      - "-DLIBXML2_WITH_TESTS=OFF"
    sources:
      - type: archive
        url: https://gitlab.gnome.org/GNOME/libxml2/-/archive/v2.11.9/libxml2-v2.11.9.tar.gz
        sha256: baa8749ef4e6f2a541813c08a5b0c987207d8d0af98cd09b40c3adf8b63dc61d

  - name: plex-binaries
    buildsystem: simple
    build-commands:
      - cp -a * /app
      - sed -i 's/BASE_DIR=\$(dirname "\$(readlink -f "\$0")")/BASE_DIR=\$(dirname "\$(readlink -f "\$0")")\/../g' /app/Plex.sh
      - sed -i 's/"\$BASE_DIR"\/bin\/Plex/"\$BASE_DIR"\/bin\/plex-bin/g' /app/Plex.sh
      - mv /app/bin/Plex /app/bin/plex-bin
      - mv /app/Plex.sh /app/bin/Plex
    # cleanup:
    #   - /lib/dri
    #   - /lib/libEGL.so*
    #   - /lib/libdrm.so*
    #   - /lib/libdrm_*.so*
    #   - /lib/libpciaccess.so*
    #   - /lib/libswresample.so*
    #   - /lib/libva.so*
    #   - /lib/libva-*.so*
    sources:
      - type: archive
        url: https://artifacts.plex.tv/plex-desktop-stable/1.112.0.359-0d79a49f/linux/Plex-1.112.0.359-0d79a49f-linux-x86_64.tar.bz2
        sha256: 05facd594832dc459b24235c5983e9b508cbece61355a9116da4e5205c477f3c
